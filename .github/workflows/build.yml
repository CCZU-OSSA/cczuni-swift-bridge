name: Build and Publish

on:
  workflow_dispatch:
  workflow_call:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - name: Install Rust
        run: rustup update stable
      - name: Prepare Environment
        run: |
          rustup target add x86_64-apple-darwin aarch64-apple-darwin aarch64-apple-ios x86_64-apple-ios aarch64-apple-ios-sim
          cargo install swift-bridge-cli
      - name: Set Permissions
        run: chmod +x build-release.sh package-release.sh
      - name: Build Release
        run: ./build-release.sh
      - name: List Release
        run: find target -name "*.a" -exec ls -lh {} \;
      - name: Package Release
        run: ./package-release.sh
      - name: List Package
        run: ls -lh CCZUniSwift
      - name: Push to CCZUniSwift Repository
        env:
          CCZUNISWIFT_PAT: ${{ secrets.CCZUNISWIFT_PAT }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global init.defaultBranch main
          mkdir ../cczuni-swift-temp
          cd ../cczuni-swift-temp
          git init
          git branch -m main
          # Copy contents of CCZUniSwift into repo root (avoid nesting the folder)
          cp -r ../cczuni-swift-bridge/CCZUniSwift/. .
          git add .
          git commit -m "Update Swift package" || echo "No changes to commit"
          git remote add origin https://x-access-token:${CCZUNISWIFT_PAT}@github.com/CCZU-OSSA/CCZUniSwift.git
          git push -u origin main --force
      - name: Archive Package
        uses: actions/upload-artifact@v4
        with:
          name: CCZUniSwift
          path: CCZUniSwift
